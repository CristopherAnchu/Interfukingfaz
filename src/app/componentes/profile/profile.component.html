<div class="profile-container">
  <!-- Header -->
  <header class="profile-header">
    <div class="header-left">
      <button (click)="goToFeed()" class="back-btn">
        <mat-icon>arrow_back</mat-icon>
        {{ i18n.translate('profile.backToFeed') }}
      </button>
    </div>
    <div class="header-center">
      <h1>{{ i18n.translate('profile.title') }}</h1>
    </div>
    <div class="header-right">
      <div class="language-selector">
        <button (click)="toggleLanguage()" class="lang-btn" [title]="'Cambiar idioma'">
          <mat-icon>language</mat-icon>
          <span class="lang-text">{{ getCurrentLanguage() }}</span>
        </button>
        <div class="lang-dropdown" *ngIf="isLanguageOpen">
          <button (click)="changeLanguage('es')" [class.active]="currentLanguage === 'es'" class="lang-option">
            <span class="flag">ES</span> Español
          </button>
          <button (click)="changeLanguage('en')" [class.active]="currentLanguage === 'en'" class="lang-option">
            <span class="flag">EN</span> English
          </button>
        </div>
      </div>
      <button (click)="logout()" class="icon-btn">
        <mat-icon>logout</mat-icon>
      </button>
    </div>
  </header>

  <!-- User Info -->
  <section class="user-info">
    <div class="user-avatar-large">
      <mat-icon>account_circle</mat-icon>
    </div>
    <h2>{{ currentUser?.nombre }} {{ currentUser?.apellido }}</h2>
    <p class="user-email">{{ currentUser?.email }}</p>
    
    <!-- Información adicional del usuario -->
    <div class="user-details">
      <div class="detail-item">
        <mat-icon>badge</mat-icon>
        <span>Cédula: {{ currentUser?.cedula }}</span>
      </div>
      <div class="detail-item">
        <mat-icon>event</mat-icon>
        <span>Último acceso: {{ currentUser?.lastLogin | date:'short' }}</span>
      </div>
    </div>

    <button (click)="openChangePasswordModal()" class="btn-change-password">
      <mat-icon>lock</mat-icon>
      Cambiar Contraseña
    </button>

    <div class="user-stats">
      <div class="stat">
        <span class="stat-number">{{ userProjects.length }}</span>
        <span class="stat-label">Proyectos</span>
      </div>
    </div>
  </section>

  <!-- Projects View -->
  <main class="profile-main" *ngIf="!selectedProject">
    <div class="section-header">
      <h3>{{ i18n.translate('profile.myProjects') }}</h3>
      <button (click)="openCreateProjectModal()" class="btn-primary">
        <mat-icon>add</mat-icon>
        {{ i18n.translate('feed.createProject') }}
      </button>
    </div>

    <div class="projects-grid" *ngIf="userProjects.length > 0">
      <div *ngFor="let project of userProjects" class="project-card">
        <div class="project-header">
          <h4>{{ project.nombre }}</h4>
          <span class="project-status" [class]="project.estado">{{ project.estado }}</span>
        </div>
        <p class="project-description">{{ project.descripcion }}</p>
        <div class="project-meta">
          <div class="meta-item">
            <mat-icon>group</mat-icon>
            <span>{{ project.colaboradores.length }} colaboradores</span>
          </div>
          <div class="meta-item">
            <mat-icon>folder</mat-icon>
            <span>{{ project.documentos.length }} documentos</span>
          </div>
        </div>
        <div class="project-actions">
          <button class="btn-primary" (click)="selectProject(project)">Abrir</button>
          <button class="btn-secondary" (click)="goToVersion(project)">Versionar</button>
        </div>
        <div class="project-tags">
          <span *ngFor="let tag of project.etiquetas" class="tag">{{ tag }}</span>
        </div>
      </div>
    </div>

    <div *ngIf="userProjects.length === 0" class="empty-state">
      <mat-icon>work_off</mat-icon>
      <p>{{ i18n.translate('profile.noProjects') }}</p>
      <button (click)="openCreateProjectModal()" class="btn-primary">{{ i18n.translate('feed.createProject') }}</button>
    </div>
  </main>

  <!-- Project Detail View -->
  <main class="profile-main" *ngIf="selectedProject">
    <div class="project-detail">
      <div class="detail-header">
        <button (click)="backToProjects()" class="back-btn-small">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <div class="detail-title">
          <h3>{{ selectedProject.nombre }}</h3>
          <span class="project-status" [class]="selectedProject.estado">{{ selectedProject.estado }}</span>
        </div>
      </div>

      <p class="project-description-full">{{ selectedProject.descripcion }}</p>

      <!-- Tabs -->
      <nav class="detail-tabs">
        <button 
          [class.active]="activeTab === 'documents'"
          (click)="activeTab = 'documents'">
          <mat-icon>folder</mat-icon>
          Documentos ({{ projectDocuments.length }})
        </button>
        <button 
          [class.active]="activeTab === 'projects'"
          (click)="activeTab = 'projects'">
          <mat-icon>group</mat-icon>
          Colaboradores ({{ selectedProject.colaboradores.length }})
        </button>
      </nav>

      <!-- Documents Tab -->
      <div *ngIf="activeTab === 'documents'" class="tab-content">
        <div class="tab-header">
          <h4>Documentos del Proyecto</h4>
          <button (click)="openUploadDocumentModal()" class="btn-primary">
            <mat-icon>upload</mat-icon>
            Subir Documento
          </button>
        </div>

        <div *ngIf="projectDocuments.length === 0" class="empty-state-small">
          <mat-icon>folder_open</mat-icon>
          <p>No hay documentos en este proyecto</p>
        </div>

        <div class="documents-grid" *ngIf="projectDocuments.length > 0">
          <div *ngFor="let doc of projectDocuments" class="document-card" (click)="openDocumentModal(doc)">
            <div class="document-icon">
              <mat-icon>{{ getFileIcon(doc.fileType) }}</mat-icon>
            </div>
            <div class="document-info">
              <h5>{{ doc.fileName }}</h5>
              <p class="document-meta">{{ doc.asunto }}</p>
              <p class="document-date">{{ doc.fechaSubida }}</p>
            </div>
            <button (click)="downloadDocument(doc); $event.stopPropagation()" class="icon-btn-small">
              <mat-icon>download</mat-icon>
            </button>
          </div>
        </div>
      </div>

      <!-- Collaborators Tab -->
      <div *ngIf="activeTab === 'projects'" class="tab-content">
        <div class="tab-header">
          <h4>Colaboradores</h4>
          <button 
            *ngIf="isProjectOwner()"
            (click)="openAddCollaboratorModal()" 
            class="btn-primary">
            <mat-icon>person_add</mat-icon>
            Agregar Colaborador
          </button>
        </div>

        <div class="collaborators-list">
          <div *ngFor="let collab of selectedProject.colaboradores" class="collaborator-item">
            <div class="collaborator-avatar">
              <mat-icon>account_circle</mat-icon>
            </div>
            <div class="collaborator-info">
              <h5>{{ collab.nombre }} {{ collab.apellido }}</h5>
              <p>{{ collab.email }}</p>
              <span class="role-badge" [class]="collab.rol">{{ collab.rol }}</span>
            </div>
            <button 
              *ngIf="isProjectOwner() && collab.rol !== 'owner'"
              (click)="removeCollaborator(collab.email)"
              class="icon-btn-danger">
              <mat-icon>person_remove</mat-icon>
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Message Toast -->
  <div *ngIf="message" class="message-toast" [ngClass]="messageType">
    {{ message }}
  </div>
</div>

<!-- Create Project Modal -->
<div *ngIf="showCreateProjectModal" class="modal-overlay" (click)="closeCreateProjectModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Crear Nuevo Proyecto</h2>
      <button (click)="closeCreateProjectModal()" class="close-btn">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    <form [formGroup]="createProjectForm" (ngSubmit)="onCreateProject()">
      <div class="form-group">
        <label for="nombre">Nombre del Proyecto</label>
        <input type="text" id="nombre" formControlName="nombre" required>
      </div>
      <div class="form-group">
        <label for="descripcion">Descripción</label>
        <textarea id="descripcion" formControlName="descripcion" rows="4" required></textarea>
      </div>
      <div class="form-group">
        <label for="etiquetas">Etiquetas (separadas por comas)</label>
        <input type="text" id="etiquetas" formControlName="etiquetas" placeholder="tecnología, educación">
      </div>
      <div class="form-group">
        <label for="visibilidad">Visibilidad</label>
        <select id="visibilidad" formControlName="visibilidad">
          <option value="publico">Público</option>
          <option value="privado">Privado</option>
        </select>
      </div>
      <div class="modal-actions">
        <button type="button" (click)="closeCreateProjectModal()" class="btn-secondary">Cancelar</button>
        <button type="submit" [disabled]="createProjectForm.invalid" class="btn-primary">Crear Proyecto</button>
      </div>
    </form>
  </div>
</div>

<!-- Add Collaborator Modal -->
<div *ngIf="showAddCollaboratorModal" class="modal-overlay" (click)="closeAddCollaboratorModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Agregar Colaborador</h2>
      <button (click)="closeAddCollaboratorModal()" class="close-btn">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    <form [formGroup]="addCollaboratorForm" (ngSubmit)="onAddCollaborator()">
      <div class="form-group">
        <label for="email">Email del Usuario</label>
        <input 
          type="email" 
          id="email" 
          formControlName="email" 
          (input)="onEmailInput($event)"
          placeholder="usuario@live.uleam.edu.ec"
          required>
        <ul class="autocomplete-list" *ngIf="showAutocomplete">
          <li 
            *ngFor="let user of autocompleteUsers"
            (click)="selectUser(user)">
            {{ user.nombres }} {{ user.apellidos }} ({{ user.email }})
          </li>
        </ul>
      </div>
      <div class="modal-actions">
        <button type="button" (click)="closeAddCollaboratorModal()" class="btn-secondary">Cancelar</button>
        <button type="submit" [disabled]="addCollaboratorForm.invalid" class="btn-primary">Agregar</button>
      </div>
    </form>
  </div>
</div>

<!-- Upload Document Modal -->
<div *ngIf="showUploadDocumentModal" class="modal-overlay" (click)="!isUploading && closeUploadDocumentModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Subir Documento</h2>
      <button (click)="closeUploadDocumentModal()" class="close-btn" [disabled]="isUploading">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    <form [formGroup]="uploadDocumentForm" (ngSubmit)="onUploadDocument()">
      <div class="form-group">
        <label for="numero">Número de Documento</label>
        <input type="text" id="numero" formControlName="numero" required>
      </div>
      <div class="form-group">
        <label for="tipo">Tipo de Documento</label>
        <input type="text" id="tipo" formControlName="tipo" required>
      </div>
      <div class="form-group">
        <label for="asunto">Asunto</label>
        <input type="text" id="asunto" formControlName="asunto" required>
      </div>
      <div class="form-group">
        <label for="descripcion">Descripción del Documento</label>
        <textarea id="descripcion" formControlName="descripcion" placeholder="Ingrese una descripción sobre el documento..." rows="4" required></textarea>
      </div>
      <div class="form-group">
        <label for="file">Seleccionar Archivo</label>
        <input type="file" id="file" (change)="onFileSelected($event)" required>
      </div>
      <div class="form-group">
        <label for="etiquetas">Etiquetas (separadas por comas)</label>
        <input type="text" id="etiquetas" formControlName="etiquetas" placeholder="informe, tesis">
      </div>
      
      <!-- Barra de progreso -->
      <div class="upload-progress" *ngIf="isUploading">
        <app-progress-bar 
          [progress]="uploadProgress" 
          label="Subiendo archivo..."
          color="#d32f2f"
          height="10px"
          [animated]="true">
        </app-progress-bar>
      </div>
      
      <div class="modal-actions">
        <button type="button" (click)="closeUploadDocumentModal()" class="btn-secondary" [disabled]="isUploading">Cancelar</button>
        <button type="submit" [disabled]="uploadDocumentForm.invalid || isUploading" class="btn-primary">
          <span *ngIf="!isUploading">Subir</span>
          <span *ngIf="isUploading">Subiendo...</span>
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Change Password Modal -->
<div *ngIf="showChangePasswordModal" class="modal-overlay" (click)="closeChangePasswordModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Cambiar Contraseña</h2>
      <button (click)="closeChangePasswordModal()" class="close-btn">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    <form [formGroup]="changePasswordForm" (ngSubmit)="onChangePassword()">
      <div class="form-group">
        <label for="currentPassword">Contraseña Actual</label>
        <div class="password-input-group">
          <input 
            [type]="showCurrentPassword ? 'text' : 'password'" 
            id="currentPassword" 
            formControlName="currentPassword" 
            required>
          <button 
            type="button" 
            class="toggle-password-btn"
            (click)="showCurrentPassword = !showCurrentPassword">
            <mat-icon>{{ showCurrentPassword ? 'visibility_off' : 'visibility' }}</mat-icon>
          </button>
        </div>
        <span class="error-text" *ngIf="changePasswordForm.get('currentPassword')?.touched && changePasswordForm.get('currentPassword')?.invalid">
          Contraseña actual requerida
        </span>
      </div>
      
      <div class="form-group">
        <label for="newPassword">Nueva Contraseña</label>
        <div class="password-input-group">
          <input 
            [type]="showNewPassword ? 'text' : 'password'" 
            id="newPassword" 
            formControlName="newPassword" 
            required>
          <button 
            type="button" 
            class="toggle-password-btn"
            (click)="showNewPassword = !showNewPassword">
            <mat-icon>{{ showNewPassword ? 'visibility_off' : 'visibility' }}</mat-icon>
          </button>
        </div>
        <span class="error-text" *ngIf="changePasswordForm.get('newPassword')?.touched && changePasswordForm.get('newPassword')?.invalid">
          La contraseña debe tener al menos 6 caracteres
        </span>
      </div>
      
      <div class="form-group">
        <label for="confirmPassword">Confirmar Nueva Contraseña</label>
        <div class="password-input-group">
          <input 
            [type]="showConfirmPassword ? 'text' : 'password'" 
            id="confirmPassword" 
            formControlName="confirmPassword" 
            required>
          <button 
            type="button" 
            class="toggle-password-btn"
            (click)="showConfirmPassword = !showConfirmPassword">
            <mat-icon>{{ showConfirmPassword ? 'visibility_off' : 'visibility' }}</mat-icon>
          </button>
        </div>
        <span class="error-text" *ngIf="changePasswordForm.get('confirmPassword')?.touched && changePasswordForm.errors?.['passwordMismatch']">
          Las contraseñas no coinciden
        </span>
      </div>

      <div class="password-requirements">
        <p><mat-icon class="info-icon">info</mat-icon> La contraseña debe tener al menos 6 caracteres</p>
      </div>
      
      <div class="modal-actions">
        <button type="button" (click)="closeChangePasswordModal()" class="btn-secondary">Cancelar</button>
        <button type="submit" [disabled]="changePasswordForm.invalid" class="btn-primary">Cambiar Contraseña</button>
      </div>
    </form>
  </div>
</div>
<!-- Document Details Modal -->
<div class="modal-overlay" *ngIf="showDocumentModal" (click)="closeDocumentModal()">
  <div class="modal-content document-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Detalles del Documento</h2>
      <button class="close-btn" (click)="closeDocumentModal()">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div *ngIf="selectedDocument" class="modal-body">
      <div class="document-detail-section">
        <div class="detail-icon">
          <mat-icon>{{ getFileIcon(selectedDocument.fileType) }}</mat-icon>
        </div>
        <h3>{{ selectedDocument.fileName }}</h3>
      </div>

      <div class="detail-grid">
        <div class="detail-item">
          <label>Número de Documento:</label>
          <p>{{ selectedDocument.numero }}</p>
        </div>
        <div class="detail-item">
          <label>Tipo de Documento:</label>
          <p>{{ selectedDocument.tipo }}</p>
        </div>
        <div class="detail-item">
          <label>Asunto:</label>
          <p>{{ selectedDocument.asunto }}</p>
        </div>
        <div class="detail-item full-width">
          <label>Descripción:</label>
          <p>{{ selectedDocument.descripcion }}</p>
        </div>
        <div class="detail-item">
          <label>Quien Subió:</label>
          <p>{{ selectedDocument.quienSube }}</p>
        </div>
        <div class="detail-item">
          <label>Para:</label>
          <p>{{ selectedDocument.paraQuienEs }}</p>
        </div>
        <div class="detail-item">
          <label>Fecha de Subida:</label>
          <p>{{ selectedDocument.fechaSubida }}</p>
        </div>
        <div class="detail-item">
          <label>Tipo de Archivo:</label>
          <p>{{ selectedDocument.fileType }}</p>
        </div>
        <div class="detail-item full-width">
          <label>Etiquetas:</label>
          <p>{{ selectedDocument.etiquetas || 'N/A' }}</p>
        </div>
      </div>
    </div>

    <div class="modal-actions">
      <button (click)="downloadDocument(selectedDocument)" class="btn-primary">
        <mat-icon>download</mat-icon>
        Descargar
      </button>
      <button (click)="closeDocumentModal()" class="btn-secondary">Cerrar</button>
    </div>
  </div>
</div>